<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bosch Product Database</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        .table-cell {
            @apply border border-gray-300 px-3 py-2 text-sm text-center align-middle;
        }
        
        .table-header {
            @apply bg-blue-600 text-white font-semibold sticky top-0 z-10 text-center align-middle;
        }
        
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded transition;
        }
        
        .btn-secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-4 py-2 rounded transition;
        }
        
        .badge {
            @apply inline-block px-2 py-1 text-xs font-semibold rounded;
        }
        
        .badge-pro {
            @apply bg-blue-100 text-blue-800;
        }
        
        .badge-diy {
            @apply bg-green-100 text-green-800;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            pointer-events: none;
        }
        
        .toast {
            pointer-events: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: start;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #3b82f6;
        }
        
        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        .toast.info { border-left-color: #3b82f6; }
        
        .toast.removing {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
            min-width: 0;
        }
        
        .toast-title {
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #6b7280;
            word-wrap: break-word;
        }
        
        .toast-close {
            color: #9ca3af;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 20px;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
        }
        
        .toast-close:hover {
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="productDatabase()" x-init="init()">
    
    <!-- Toast Notifications Container -->
    <div class="toast-container" x-data="toastManager()" id="toastContainer">
        <template x-for="toast in toasts" :key="toast.id">
            <div :class="'toast ' + toast.type + (toast.removing ? ' removing' : '')"
                 x-show="!toast.hidden"
                 x-transition>
                <div class="toast-icon">
                    <span x-show="toast.type === 'success'">‚úÖ</span>
                    <span x-show="toast.type === 'error'">‚ùå</span>
                    <span x-show="toast.type === 'warning'">‚ö†Ô∏è</span>
                    <span x-show="toast.type === 'info'">‚ÑπÔ∏è</span>
                </div>
                <div class="toast-content">
                    <div class="toast-title" x-text="toast.title"></div>
                    <div class="toast-message" x-text="toast.message"></div>
                </div>
                <button @click="removeToast(toast.id)" class="toast-close">√ó</button>
            </div>
        </template>
    </div>
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-full mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Bosch Product Database</h1>
                    <p class="text-sm text-gray-600 mt-1">Manage products and generate JSONs for Rhino plugin</p>
                </div>
                <div class="flex gap-3">
                    <button @click="showAddProduct()" class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded transition">
                        ‚ûï New Product
                    </button>
                    <button @click="scanDatabase()" class="btn-secondary">
                        <span x-show="!scanning">üîÑ Scan Database</span>
                        <span x-show="scanning" x-cloak>‚è≥ Scanning...</span>
                    </button>
                    <button @click="extractPreviews()" class="btn-secondary">
                        <span x-show="!extracting">üñºÔ∏è Extract Previews</span>
                        <span x-show="extracting" x-cloak>‚è≥ Extracting...</span>
                    </button>
                    <button @click="forceRefresh()" class="btn-primary" :disabled="loading">
                        <span x-show="!loading">üîÉ Refresh</span>
                        <span x-show="loading" x-cloak>‚è≥ Loading...</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-full mx-auto px-6 py-6">
        
        <!-- Search and Filter Bar -->
        <div x-show="!loading" x-cloak class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search Box -->
                <div class="md:col-span-2">
                    <input type="text" 
                           x-model="searchQuery" 
                           @input="filterProducts()"
                           placeholder="üîç Search products, SKU, description, tags..."
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Range Filter -->
                <div>
                    <select x-model="filterRange" 
                            @change="filterProducts()"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">All Ranges</option>
                        <option value="PRO">PRO</option>
                        <option value="DIY">DIY</option>
                    </select>
                </div>
                
                <!-- Category Filter -->
                <div>
                    <select x-model="filterCategory" 
                            @change="filterProducts()"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">All Categories</option>
                        <template x-for="cat in categories" :key="cat">
                            <option :value="cat" x-text="cat"></option>
                        </template>
                    </select>
                </div>
            </div>
            
            <!-- Results Count & Active Filters -->
            <div class="mt-3 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-600">
                        Showing 
                        <span class="font-semibold" x-text="Math.min(((currentPage - 1) * itemsPerPage) + 1, filteredProducts.length)"></span>-<span class="font-semibold" x-text="Math.min(currentPage * itemsPerPage, filteredProducts.length)"></span> 
                        of <span class="font-semibold" x-text="filteredProducts.length"></span> products
                        <span x-show="filteredProducts.length < allProducts.length" class="text-gray-500">
                            (filtered from <span x-text="allProducts.length"></span>)
                        </span>
                    </span>
                    
                    <!-- Column Visibility Dropdown -->
                    <div class="relative" x-data="{ open: false }" @click.away="open = false">
                        <button @click="open = !open" 
                                class="flex items-center gap-2 px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Columns
                            <span class="text-xs text-gray-500" x-text="`(${visibleColumnCount}/10)`"></span>
                        </button>
                        
                        <div x-show="open" x-cloak
                             class="absolute left-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-50 py-2">
                            <div class="px-3 py-2 border-b border-gray-200">
                                <p class="text-xs font-semibold text-gray-700 uppercase">Show/Hide Columns</p>
                            </div>
                            <div class="max-h-80 overflow-y-auto py-1">
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.preview" class="rounded border-gray-300">
                                    <span class="text-sm">Preview</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.productName" class="rounded border-gray-300">
                                    <span class="text-sm">Product Name</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.description" class="rounded border-gray-300">
                                    <span class="text-sm">Description</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.sku" class="rounded border-gray-300">
                                    <span class="text-sm">SKU</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.codArticol" class="rounded border-gray-300">
                                    <span class="text-sm">Cod Articol</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.range" class="rounded border-gray-300">
                                    <span class="text-sm">Range</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.category" class="rounded border-gray-300">
                                    <span class="text-sm">Category</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.holderVariant" class="rounded border-gray-300">
                                    <span class="text-sm">Holder Variant</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.color" class="rounded border-gray-300">
                                    <span class="text-sm">Color</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" x-model="visibleColumns.holderPreview" class="rounded border-gray-300">
                                    <span class="text-sm">Holder Preview</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div x-show="searchQuery || filterRange || filterCategory" class="flex items-center gap-2 flex-wrap">
                    <span x-show="searchQuery" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded flex items-center gap-1">
                        <span x-text="'Search: ' + searchQuery"></span>
                        <button @click="searchQuery = ''; filterProducts()" class="hover:text-blue-900">√ó</button>
                    </span>
                    <span x-show="filterRange" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded flex items-center gap-1">
                        <span x-text="'Range: ' + filterRange"></span>
                        <button @click="filterRange = ''; filterProducts()" class="hover:text-green-900">√ó</button>
                    </span>
                    <span x-show="filterCategory" class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded flex items-center gap-1">
                        <span x-text="'Category: ' + filterCategory"></span>
                        <button @click="filterCategory = ''; filterProducts()" class="hover:text-purple-900">√ó</button>
                    </span>
                    <button @click="clearFilters()" class="text-xs text-blue-600 hover:text-blue-800 underline ml-2">Clear all</button>
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div x-show="loading" x-cloak class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Loading products...</p>
        </div>

        <!-- Bulk Actions Toolbar -->
        <div x-show="!loading && selectedCount > 0" x-cloak 
             class="bg-blue-50 border border-blue-200 rounded-lg shadow-sm px-6 py-3 mb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <span class="text-blue-900 font-semibold" x-text="`${selectedCount} selected`"></span>
                    <button @click="deselectAll()" class="text-sm text-blue-700 hover:text-blue-900 underline">
                        Clear Selection
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <button @click="bulkAutoPopulate()" 
                            :disabled="bulkProcessing"
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        <span x-show="!bulkProcessing">ü§ñ Bulk Auto-Populate</span>
                        <span x-show="bulkProcessing">‚è≥ Processing...</span>
                    </button>
                    <button @click="bulkExtractPreviews()" 
                            :disabled="bulkProcessing"
                            class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        <span x-show="!bulkProcessing">üñºÔ∏è Bulk Extract Previews</span>
                        <span x-show="bulkProcessing">‚è≥ Processing...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div x-show="!loading" x-cloak class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            
            <!-- Table Header -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th class="table-cell table-header w-12">
                                <input type="checkbox" 
                                       :checked="allPageSelected"
                                       @change="toggleSelectAll()"
                                       class="w-4 h-4 rounded border-gray-300 cursor-pointer">
                            </th>
                            <th class="table-cell table-header w-8">#</th>
                            <th x-show="visibleColumns.preview" class="table-cell table-header w-20">Preview</th>
                            <th x-show="visibleColumns.productName" class="table-cell table-header w-40 cursor-pointer hover:bg-blue-700" @click="sortBy('productName')">
                                <div class="flex items-center justify-center gap-1">
                                    Product Name
                                    <span x-show="sortColumn === 'productName'" x-text="sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </div>
                            </th>
                            <th x-show="visibleColumns.description" class="table-cell table-header w-56">Description</th>
                            <th x-show="visibleColumns.sku" class="table-cell table-header w-28 cursor-pointer hover:bg-blue-700" @click="sortBy('sku')">
                                <div class="flex items-center justify-center gap-1">
                                    SKU
                                    <span x-show="sortColumn === 'sku'" x-text="sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </div>
                            </th>
                            <th x-show="visibleColumns.codArticol" class="table-cell table-header w-32">Cod Articol</th>
                            <th x-show="visibleColumns.range" class="table-cell table-header w-16 cursor-pointer hover:bg-blue-700" @click="sortBy('range')">
                                <div class="flex items-center justify-center gap-1">
                                    Range
                                    <span x-show="sortColumn === 'range'" x-text="sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </div>
                            </th>
                            <th x-show="visibleColumns.category" class="table-cell table-header w-28 cursor-pointer hover:bg-blue-700" @click="sortBy('category')">
                                <div class="flex items-center justify-center gap-1">
                                    Category
                                    <span x-show="sortColumn === 'category'" x-text="sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </div>
                            </th>
                            <th x-show="visibleColumns.holderVariant" class="table-cell table-header w-32">Holder Variant</th>
                            <th x-show="visibleColumns.color" class="table-cell table-header w-28">Color</th>
                            <th x-show="visibleColumns.holderPreview" class="table-cell table-header w-28">Holder Preview</th>
                            <th class="table-cell table-header w-32">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="(product, index) in paginatedProducts" :key="product.productName">
                            <tr class="hover:bg-gray-50 transition" 
                                :class="selectedProducts.has(product.productName) ? 'bg-blue-50' : ''"
                                x-data="{ rowVariant: getFirstHolder(product)?.variant || '', rowColor: getFirstHolder(product)?.color || '' }">
                                <!-- Checkbox -->
                                <td class="table-cell">
                                    <input type="checkbox" 
                                           :checked="selectedProducts.has(product.productName)"
                                           @change="toggleProductSelection(product.productName)"
                                           class="w-4 h-4 rounded border-gray-300 cursor-pointer">
                                </td>
                                <td class="table-cell text-gray-500" x-text="((currentPage - 1) * itemsPerPage) + index + 1"></td>
                                
                                <!-- Product Preview Thumbnail -->
                                <td x-show="visibleColumns.preview" class="table-cell p-1">
                                    <div class="w-16 h-16 bg-gray-100 rounded border border-gray-200 overflow-hidden cursor-pointer hover:opacity-80 flex items-center justify-center"
                                         @click="showPreview(product)">
                                        <img x-show="getPreviewPath(product, 'meshPreview')" 
                                             :src="getPreviewUrl(product, 'meshPreview')" 
                                             class="w-full h-full object-contain"
                                             :alt="product.productName">
                                        <span x-show="!getPreviewPath(product, 'meshPreview')" 
                                              class="text-xs text-gray-400">No preview</span>
                                    </div>
                                </td>
                                
                                <!-- Product Name -->
                                <td x-show="visibleColumns.productName" class="table-cell font-medium text-gray-900" x-text="product.productName"></td>
                                
                                <!-- Description -->
                                <td x-show="visibleColumns.description" class="table-cell text-gray-700 text-sm" x-text="product.description"></td>
                                
                                <!-- SKU -->
                                <td x-show="visibleColumns.sku" class="table-cell text-gray-600 font-mono text-xs" x-text="product.sku"></td>
                                
                                <!-- Cod Articol (Dynamic) -->
                                <td x-show="visibleColumns.codArticol" class="table-cell font-mono text-xs font-semibold" 
                                    x-text="getHolderBySelection(product, rowVariant, rowColor)?.codArticol || ''"></td>
                                
                                <!-- Range -->
                                <td x-show="visibleColumns.range" class="table-cell">
                                    <span class="badge" :class="product.range === 'PRO' ? 'badge-pro' : 'badge-diy'" 
                                          x-text="product.range"></span>
                                </td>
                                
                                <!-- Category -->
                                <td x-show="visibleColumns.category" class="table-cell text-gray-700 text-sm" x-text="product.category"></td>
                                
                                <!-- Holder Variant Dropdown -->
                                <td x-show="visibleColumns.holderVariant" class="table-cell p-1">
                                    <select x-model="rowVariant" 
                                            x-show="product.holders && product.holders.length > 0"
                                            class="w-full text-xs border border-gray-300 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500">
                                        <template x-for="variant in getUniqueValues(product, 'variant')" :key="variant">
                                            <option :value="variant" x-text="variant"></option>
                                        </template>
                                    </select>
                                </td>
                                
                                <!-- Color Dropdown -->
                                <td x-show="visibleColumns.color" class="table-cell p-1">
                                    <select x-model="rowColor" 
                                            x-show="product.holders && product.holders.length > 0"
                                            class="w-full text-xs border border-gray-300 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500">
                                        <template x-for="color in getUniqueValues(product, 'color')" :key="color">
                                            <option :value="color" x-text="color"></option>
                                        </template>
                                    </select>
                                </td>
                                
                                <!-- Holder Preview (Dynamic) -->
                                <td x-show="visibleColumns.holderPreview" class="table-cell p-1">
                                    <div x-show="getHolderBySelection(product, rowVariant, rowColor)?.preview"
                                         class="w-12 h-12 bg-gray-100 rounded border border-gray-200 overflow-hidden cursor-pointer hover:opacity-80 flex items-center justify-center"
                                         @click="showImagePreview(getHolderPreviewUrl(getHolderBySelection(product, rowVariant, rowColor)?.preview))">
                                        <img :src="getHolderPreviewUrl(getHolderBySelection(product, rowVariant, rowColor)?.preview)" 
                                             class="w-full h-full object-contain"
                                             alt="Holder preview">
                                    </div>
                                    <div x-show="!getHolderBySelection(product, rowVariant, rowColor)?.preview"
                                         class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-400">
                                        -
                                    </div>
                                </td>
                                
                                <!-- Actions -->
                                <td class="table-cell">
                                    <div class="flex gap-2">
                                        <button @click="editProduct(product)" 
                                                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button @click="autoPopulate(product)" 
                                                class="text-green-600 hover:text-green-800 text-sm font-medium">
                                            ü§ñ Auto
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <!-- Left: Results info -->
                    <div class="text-sm text-gray-600">
                        Showing 
                        <span class="font-semibold" x-text="Math.min(((currentPage - 1) * itemsPerPage) + 1, filteredProducts.length)"></span>-<span class="font-semibold" x-text="Math.min(currentPage * itemsPerPage, filteredProducts.length)"></span> 
                        of <span class="font-semibold" x-text="filteredProducts.length"></span> products
                    </div>
                    
                    <!-- Center: Page navigation -->
                    <div x-show="totalPages > 1" class="flex items-center gap-2">
                        <!-- First -->
                        <button @click="firstPage()" 
                                :disabled="currentPage === 1"
                                :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
                                class="px-3 py-1 border border-gray-300 rounded bg-white text-sm font-medium">
                            ‚Äπ‚Äπ
                        </button>
                        
                        <!-- Previous -->
                        <button @click="prevPage()" 
                                :disabled="currentPage === 1"
                                :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
                                class="px-3 py-1 border border-gray-300 rounded bg-white text-sm font-medium">
                            ‚Äπ
                        </button>
                        
                        <!-- Page numbers -->
                        <template x-for="page in pageNumbers" :key="page">
                            <button x-show="page !== '...'"
                                    @click="goToPage(page)"
                                    :class="page === currentPage ? 'bg-blue-500 text-white' : 'bg-white hover:bg-gray-100'"
                                    class="px-3 py-1 border border-gray-300 rounded text-sm font-medium"
                                    x-text="page">
                            </button>
                            <span x-show="page === '...'" class="px-2 text-gray-500">...</span>
                        </template>
                        
                        <!-- Next -->
                        <button @click="nextPage()" 
                                :disabled="currentPage === totalPages"
                                :class="currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
                                class="px-3 py-1 border border-gray-300 rounded bg-white text-sm font-medium">
                            ‚Ä∫
                        </button>
                        
                        <!-- Last -->
                        <button @click="lastPage()" 
                                :disabled="currentPage === totalPages"
                                :class="currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
                                class="px-3 py-1 border border-gray-300 rounded bg-white text-sm font-medium">
                            ‚Ä∫‚Ä∫
                        </button>
                    </div>
                    
                    <!-- Right: Items per page -->
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-600">Items per page:</span>
                        <select x-model="itemsPerPage" @change="changeItemsPerPage($event.target.value)"
                                class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal (Enhanced) -->
        <div x-show="editingProduct" x-cloak 
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
             @click.self="closeEditModal()">
            <template x-if="editingProduct">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <div class="text-white">
                            <h2 class="text-2xl font-bold" x-text="editingProduct?.productName"></h2>
                            <p class="text-blue-100 text-sm mt-1 cursor-pointer hover:text-white hover:underline flex items-center gap-2" 
                               @click="openFolder(editingProduct?._folder)"
                               title="Click to open folder">
                                üìÅ <span x-text="editingProduct?._folder"></span>
                            </p>
                        </div>
                        <button @click="closeEditModal()" class="text-white hover:text-gray-200 transition">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Modal Content -->
                <div class="flex-1 overflow-y-auto px-6 py-6">
                    <div class="grid grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-6">
                            <!-- Basic Info -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                    üìù Basic Information
                                </h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <textarea x-model="editingProduct.description" 
                                                  @input="checkDirty()"
                                                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                  rows="3"></textarea>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">SKU</label>
                                            <input type="text" x-model="editingProduct.sku" 
                                                   @input="checkDirty()"
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Range</label>
                                            <select x-model="editingProduct.range" 
                                                    @change="checkDirty()"
                                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                                <option value="PRO">PRO</option>
                                                <option value="DIY">DIY</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                            <input type="text" x-model="editingProduct.category" 
                                                   @input="checkDirty()"
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Subcategory</label>
                                            <input type="text" x-model="editingProduct.subcategory" 
                                                   @input="checkDirty()"
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Tags -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                    üè∑Ô∏è Tags
                                </h3>
                                <div>
                                    <div class="flex flex-wrap gap-2 mb-2">
                                        <template x-for="(tag, idx) in editingProduct.tags" :key="idx">
                                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                                                <span x-text="tag"></span>
                                                <button @click="editingProduct.tags.splice(idx, 1)" 
                                                        class="hover:text-red-600">
                                                    √ó
                                                </button>
                                            </span>
                                        </template>
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" x-model="newTag" 
                                               @keydown.enter="addTag()"
                                               placeholder="Add tag..."
                                               class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                        <button @click="addTag(); checkDirty();" class="btn-primary px-3">
                                            ‚ûï
                                        </button>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Notes -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                    üìã Notes
                                </h3>
                                <textarea x-model="editingProduct.notes" 
                                          @input="checkDirty()"
                                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
                                          rows="4"
                                          placeholder="Internal notes..."></textarea>
                            </section>
                            
                            <!-- Packaging Dimensions -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                    üì¶ Packaging Dimensions <span class="text-sm text-gray-500 font-normal ml-2">(Optional)</span>
                                </h3>
                                <div class="grid grid-cols-4 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Length (cm)</label>
                                        <input type="number" 
                                               x-model="editingProduct.packaging.length" 
                                               @input="checkDirty()"
                                               step="0.1"
                                               placeholder="0.0"
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Width (cm)</label>
                                        <input type="number" 
                                               x-model="editingProduct.packaging.width" 
                                               @input="checkDirty()"
                                               step="0.1"
                                               placeholder="0.0"
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Height (cm)</label>
                                        <input type="number" 
                                               x-model="editingProduct.packaging.height" 
                                               @input="checkDirty()"
                                               step="0.1"
                                               placeholder="0.0"
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Weight (kg)</label>
                                        <input type="number" 
                                               x-model="editingProduct.packaging.weight" 
                                               @input="checkDirty()"
                                               step="0.1"
                                               placeholder="0.0"
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </section>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="space-y-6">
                            <!-- Preview Images -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                    üñºÔ∏è Previews
                                </h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <!-- Mesh Preview -->
                                    <div class="border border-gray-300 rounded-lg p-3 bg-gray-50">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-sm font-medium text-gray-700">Mesh</div>
                                            <button @click="openFilePicker('mesh')" 
                                                    class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1"
                                                    title="Browse for mesh preview image">
                                                üìÅ Browse
                                            </button>
                                        </div>
                                        <div x-show="getPreviewPath(editingProduct, 'meshPreview')" 
                                             class="aspect-square bg-white rounded border border-gray-200 overflow-hidden cursor-pointer hover:opacity-80"
                                             @click="showImagePreview(getPreviewUrl(editingProduct, 'meshPreview'))">
                                            <img :src="getPreviewUrl(editingProduct, 'meshPreview')" 
                                                 class="w-full h-full object-contain">
                                        </div>
                                        <div x-show="!getPreviewPath(editingProduct, 'meshPreview')" 
                                             class="aspect-square bg-gray-200 rounded flex items-center justify-center text-gray-400 text-sm">
                                            No preview
                                        </div>
                                    </div>
                                    
                                    <!-- Grafica Preview -->
                                    <div class="border border-gray-300 rounded-lg p-3 bg-gray-50">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-sm font-medium text-gray-700">Grafica</div>
                                            <button @click="openFilePicker('grafica')" 
                                                    class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1"
                                                    title="Browse for grafica preview image">
                                                üìÅ Browse
                                            </button>
                                        </div>
                                        <div x-show="getPreviewPath(editingProduct, 'graficaPreview')" 
                                             class="aspect-square bg-white rounded border border-gray-200 overflow-hidden cursor-pointer hover:opacity-80"
                                             @click="showImagePreview(getPreviewUrl(editingProduct, 'graficaPreview'))">
                                            <img :src="getPreviewUrl(editingProduct, 'graficaPreview')" 
                                                 class="w-full h-full object-contain">
                                        </div>
                                        <div x-show="!getPreviewPath(editingProduct, 'graficaPreview')" 
                                             class="aspect-square bg-gray-200 rounded flex items-center justify-center text-gray-400 text-sm">
                                            No preview
                                        </div>
                                    </div>
                                    
                                    <!-- Packaging Preview -->
                                    <div class="border border-gray-300 rounded-lg p-3 bg-gray-50">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-sm font-medium text-gray-700">Packaging</div>
                                            <button @click="openFilePicker('packaging')" 
                                                    class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1"
                                                    title="Browse for packaging preview image">
                                                üìÅ Browse
                                            </button>
                                        </div>
                                        <div x-show="editingProduct?.packaging?.preview" 
                                             class="aspect-square bg-white rounded border border-gray-200 overflow-hidden cursor-pointer hover:opacity-80"
                                             @click="showImagePreview(getPreviewUrl(editingProduct, 'packagingPreview'))">
                                            <img :src="getPreviewUrl(editingProduct, 'packagingPreview')" 
                                                 class="w-full h-full object-contain">
                                        </div>
                                        <div x-show="!editingProduct?.packaging?.preview" 
                                             class="aspect-square bg-gray-200 rounded flex items-center justify-center text-gray-400 text-sm">
                                            No preview
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Holders Section with Live Dropdown -->
                            <section>
                                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                    üîß Holders
                                    <span class="ml-2 text-sm font-normal text-gray-500" x-text="`(${editingProduct?.holders?.length || 0} total)`"></span>
                                    <button @click="addNewHolder()" 
                                            class="ml-auto text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg flex items-center gap-1">
                                        ‚ûï Add Holder
                                    </button>
                                </h3>
                                
                                <!-- Current Selection -->
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                    <div class="text-sm font-medium text-blue-900 mb-3">Current Selection</div>
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-xs font-medium text-blue-700 mb-1">Variant</label>
                                            <select x-model="selectedVariant" 
                                                    @change="updateHolderSelection()"
                                                    class="w-full border border-blue-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                                <option value="">Select variant...</option>
                                                <template x-for="variant in getUniqueHolderValues('variant')" :key="variant">
                                                    <option :value="variant" x-text="variant"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-blue-700 mb-1">Color</label>
                                            <select x-model="selectedColor" 
                                                    @change="updateHolderSelection()"
                                                    class="w-full border border-blue-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                                <option value="">Select color...</option>
                                                <template x-for="color in getUniqueHolderValues('color')" :key="color">
                                                    <option :value="color" x-text="color"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Selected Holder Info -->
                                    <div x-show="selectedHolder" class="bg-white rounded-lg p-3 space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs font-medium text-gray-600">Cod Articol:</span>
                                            <span class="text-sm font-mono font-semibold text-gray-900" x-text="selectedHolder?.codArticol"></span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs font-medium text-gray-600">File:</span>
                                            <span class="text-xs font-mono text-gray-700" x-text="selectedHolder?.fileName"></span>
                                        </div>
                                        <div x-show="selectedHolder?.fullPath" class="flex items-center justify-between">
                                            <span class="text-xs font-medium text-gray-600">Location:</span>
                                            <button @click="revealInExplorer(selectedHolder?.fullPath)" 
                                                    class="text-xs text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1"
                                                    title="Reveal in Explorer">
                                                üìÇ Reveal in Explorer
                                            </button>
                                        </div>
                                        <div class="mt-2">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-xs font-medium text-gray-600">Preview:</span>
                                                <button @click="browseHolderPreview()" 
                                                        class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1"
                                                        title="Browse for holder preview image">
                                                    üìÅ Browse Preview
                                                </button>
                                            </div>
                                            <div x-show="selectedHolder?.preview" class="aspect-video bg-gray-100 rounded border border-gray-200 overflow-hidden cursor-pointer hover:opacity-80"
                                                 @click="showImagePreview(selectedHolder?.preview)">
                                                <img :src="getHolderPreviewUrl(selectedHolder?.preview)" 
                                                     class="w-full h-full object-contain">
                                            </div>
                                            <div x-show="!selectedHolder?.preview" class="aspect-video bg-gray-200 rounded flex items-center justify-center text-gray-400 text-sm">
                                                No preview
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- All Holders List (Editable) -->
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    <template x-for="(holder, idx) in editingProduct.holders" :key="idx">
                                        <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 hover:border-blue-300 transition">
                                            <div class="flex items-start justify-between gap-3 mb-3">
                                                <div class="text-sm font-semibold text-gray-700">Holder #<span x-text="idx + 1"></span></div>
                                                <button @click="removeHolder(idx)" 
                                                        class="text-red-600 hover:text-red-800 hover:bg-red-50 px-2 py-1 rounded text-sm font-medium"
                                                        title="Remove this holder">
                                                    üóëÔ∏è Remove
                                                </button>
                                            </div>
                                            
                                            <div class="grid grid-cols-3 gap-3 mb-3">
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">Variant</label>
                                                    <input type="text" 
                                                           :value="holder.variant"
                                                           @input="updateHolderField(idx, 'variant', $event.target.value)"
                                                           placeholder="e.g., Tego"
                                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">Color</label>
                                                    <input type="text" 
                                                           :value="holder.color"
                                                           @input="updateHolderField(idx, 'color', $event.target.value)"
                                                           placeholder="e.g., RAL7043"
                                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">Cod Articol</label>
                                                    <input type="text" 
                                                           :value="holder.codArticol"
                                                           @input="updateHolderField(idx, 'codArticol', $event.target.value)"
                                                           placeholder="e.g., BO.161.9LL8600"
                                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm font-mono focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                            
                                            <div class="flex items-center gap-2 pt-2 border-t border-gray-200">
                                                <span class="text-xs text-gray-500">File:</span>
                                                <span class="text-xs font-mono text-gray-700 flex-1" x-text="holder.fileName || 'Not set'"></span>
                                                <button x-show="holder.fullPath" 
                                                        @click="revealInExplorer(holder.fullPath)"
                                                        class="text-xs text-blue-600 hover:text-blue-800 whitespace-nowrap"
                                                        title="Reveal in Explorer">
                                                    üìÇ Reveal
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-between items-center flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <button @click="autoPopulate(editingProduct)" 
                                class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg transition">
                            ü§ñ Auto-Populate
                        </button>
                        <button x-show="isDirty" @click="revertChanges()" 
                                class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium px-4 py-2 rounded-lg transition">
                            ‚Ü©Ô∏è Revert Changes
                        </button>
                        <span x-show="isDirty" class="text-orange-600 font-semibold text-sm">
                            ‚óè Unsaved changes
                        </span>
                    </div>
                    <div class="flex gap-3">
                        <button @click="closeEditModal()" class="btn-secondary">
                            Cancel
                        </button>
                        <button @click="saveProduct()" class="btn-primary" :disabled="!isDirty">
                            üíæ Save Changes
                        </button>
                    </div>
                </div>
            </div>
            </template>
        </div>
        
        <!-- Add Product Modal (Enhanced) -->
        <div x-show="addingProduct" x-cloak 
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto"
             @click.self="closeAddModal()">
            <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full my-8">
                <div class="bg-green-600 px-6 py-4">
                    <h2 class="text-xl font-bold text-white">‚ûï Add New Product</h2>
                    <p class="text-green-100 text-sm mt-1">Fields marked with * are required</p>
                </div>
                
                <div class="px-6 py-6 grid grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700 border-b pb-2">Basic Information</h3>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Product Folder Path *
                                <span class="text-xs text-gray-500 font-normal">(Required)</span>
                            </label>
                            <input type="text" x-model="newProductPath" 
                                   placeholder="M:\Proiectare\...\PRO\Garden\ProductName"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-green-500"
                                   required>
                            <p class="text-xs text-gray-500 mt-1">Product name will be extracted from folder name</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Range *
                                </label>
                                <select x-model="newProductRange" 
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
                                    <option value="PRO">PRO</option>
                                    <option value="DIY">DIY</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Category
                                    <span class="text-xs text-gray-500 font-normal">(Optional)</span>
                                </label>
                                <input type="text" x-model="newProductCategory" 
                                       placeholder="e.g., Garden, Drills"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Subcategory
                                <span class="text-xs text-gray-500 font-normal">(Optional)</span>
                            </label>
                            <input type="text" x-model="newProductSubcategory" 
                                   placeholder="e.g., Cordless Blowers"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Description
                                <span class="text-xs text-gray-500 font-normal">(Optional)</span>
                            </label>
                            <textarea x-model="newProductDescription" 
                                      placeholder="Brief description of the product..."
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500"
                                      rows="3"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    SKU
                                    <span class="text-xs text-gray-500 font-normal">(Optional)</span>
                                </label>
                                <input type="text" x-model="newProductSKU" 
                                       placeholder="0.601.9H1.100"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Cod Articol
                                    <span class="text-xs text-gray-500 font-normal">(Optional)</span>
                                </label>
                                <input type="text" x-model="newProductCodArticol" 
                                       placeholder="Article code"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Tags
                                <span class="text-xs text-gray-500 font-normal">(Optional, comma-separated)</span>
                            </label>
                            <input type="text" x-model="newProductTags" 
                                   placeholder="cordless, 18V, lightweight"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
                            <p class="text-xs text-gray-500 mt-1">Separate tags with commas</p>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700 border-b pb-2">Additional Details</h3>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Packaging Dimensions
                                <span class="text-xs text-gray-500 font-normal">(Optional)</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-gray-600">Length (cm)</label>
                                    <input type="number" x-model="newProductPackaging.length" 
                                           step="0.1" placeholder="45.5"
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">Width (cm)</label>
                                    <input type="number" x-model="newProductPackaging.width" 
                                           step="0.1" placeholder="30.0"
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">Height (cm)</label>
                                    <input type="number" x-model="newProductPackaging.height" 
                                           step="0.1" placeholder="25.0"
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">Weight (kg)</label>
                                    <input type="number" x-model="newProductPackaging.weight" 
                                           step="0.1" placeholder="2.5"
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-green-500">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Notes
                                <span class="text-xs text-gray-500 font-normal">(Optional)</span>
                            </label>
                            <textarea x-model="newProductNotes" 
                                      placeholder="Internal notes, usage instructions, etc..."
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500"
                                      rows="3"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Holder Names
                                <span class="text-xs text-gray-500 font-normal">(Optional, one per line)</span>
                            </label>
                            <textarea x-model="newProductHolders" 
                                      placeholder="Tego_RAL7043_BO.161.9LL8600&#10;Tego_RAL9006_BO.161.9LL8601&#10;Traverse_RAL7043_NN.ALL.BO07802"
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 font-mono text-xs focus:ring-2 focus:ring-green-500"
                                      rows="5"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Format: Variant_Color_CodArticol</p>
                            <p class="text-xs text-gray-500">Script will auto-locate files in Holders folder</p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-xs text-blue-800">
                                <strong>üí° Tip:</strong> After creating the product, use the <strong>ü§ñ Auto-Populate</strong> button 
                                to automatically scan and populate all file paths from the folder structure.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 border-t px-6 py-4 flex justify-between items-center">
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">Required fields:</span> Product Path, Range
                    </p>
                    <div class="flex gap-3">
                        <button @click="closeAddModal()" class="btn-secondary">Cancel</button>
                        <button @click="createProduct()" class="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-2 rounded-lg transition">
                            ‚ú® Create Product
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Image Preview Modal -->
        <div x-show="imagePreview" x-cloak 
             class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4"
             @click="closeImagePreview()">
            <div class="relative max-w-7xl max-h-full">
                <button @click="closeImagePreview()" 
                        class="absolute top-4 right-4 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <img :src="imagePreview" class="max-w-full max-h-screen object-contain" @click.stop>
            </div>
        </div>

    </main>

    <script>
        // Toast Notification Manager
        function toastManager() {
            return {
                toasts: [],
                nextId: 1,
                
                show(type, title, message, duration = 5000) {
                    const id = this.nextId++;
                    const toast = { id, type, title, message, hidden: false, removing: false };
                    this.toasts.push(toast);
                    
                    if (duration > 0) {
                        setTimeout(() => this.removeToast(id), duration);
                    }
                    
                    return id;
                },
                
                success(title, message, duration = 5000) {
                    return this.show('success', title, message, duration);
                },
                
                error(title, message, duration = 0) {
                    return this.show('error', title, message, duration);  // Errors don't auto-dismiss
                },
                
                warning(title, message, duration = 7000) {
                    return this.show('warning', title, message, duration);
                },
                
                info(title, message, duration = 5000) {
                    return this.show('info', title, message, duration);
                },
                
                removeToast(id) {
                    const toast = this.toasts.find(t => t.id === id);
                    if (toast) {
                        toast.removing = true;
                        setTimeout(() => {
                            this.toasts = this.toasts.filter(t => t.id !== id);
                        }, 300);
                    }
                }
            }
        }
        
        // Global toast helper
        window.toast = {
            success: (title, message) => {
                const container = document.getElementById('toastContainer');
                if (container && container.__x) {
                    container.__x.$data.success(title, message);
                }
            },
            error: (title, message) => {
                const container = document.getElementById('toastContainer');
                if (container && container.__x) {
                    container.__x.$data.error(title, message);
                }
            },
            warning: (title, message) => {
                const container = document.getElementById('toastContainer');
                if (container && container.__x) {
                    container.__x.$data.warning(title, message);
                }
            },
            info: (title, message) => {
                const container = document.getElementById('toastContainer');
                if (container && container.__x) {
                    container.__x.$data.info(title, message);
                }
            }
        };
        
        function productDatabase() {
            return {
                products: [],
                allProducts: [],
                filteredProducts: [],
                loading: true,
                scanning: false,
                extracting: false,
                editingProduct: null,
                addingProduct: false,
                imagePreview: null,
                
                // Search and filter state
                searchQuery: '',
                filterRange: '',
                filterCategory: '',
                categories: [],
                
                // Sort state
                sortColumn: '',
                sortDirection: 'asc',
                
                // Pagination state
                currentPage: 1,
                itemsPerPage: 50,
                
                // Bulk selection state
                selectedProducts: new Set(),
                bulkProcessing: false,
                
                // Column visibility state
                visibleColumns: {
                    preview: true,
                    productName: true,
                    description: true,
                    sku: true,
                    codArticol: true,
                    range: true,
                    category: true,
                    holderVariant: true,
                    color: true,
                    holderPreview: true
                },
                showColumnMenu: false,
                
                // Edit modal state
                selectedVariant: '',
                selectedColor: '',
                selectedHolder: null,
                newTag: '',
                originalProduct: null,  // For dirty state tracking
                isDirty: false,  // Track unsaved changes
                
                // Add product modal state
                newProductPath: '',
                newProductRange: 'PRO',
                newProductCategory: '',
                newProductSubcategory: '',
                newProductDescription: '',
                newProductSKU: '',
                newProductCodArticol: '',
                newProductTags: '',
                newProductNotes: '',
                newProductHolders: '',
                newProductPackaging: {
                    length: null,
                    width: null,
                    height: null,
                    weight: null
                },

                async init() {
                    await this.refreshProducts();
                },

                async refreshProducts(force = false) {
                    this.loading = true;
                    try {
                        const url = force ? '/api/products?force_refresh=true' : '/api/products';
                        const response = await fetch(url);
                        const data = await response.json();
                        this.products = data.products;
                        this.allProducts = this.products;
                        this.filteredProducts = this.products;
                        
                        // Extract unique categories
                        this.categories = [...new Set(this.products.map(p => p.category))].filter(c => c).sort();
                        
                        console.log(`üì¶ Loaded ${data.count} products ${force ? '(forced refresh)' : '(from cache)'}`);
                    } catch (error) {
                        console.error('Error loading products:', error);
                        window.toast.error('Load Failed', 'Failed to load products');
                    }
                    this.loading = false;
                },

                async forceRefresh() {
                    this.loading = true;
                    try {
                        // Use the dedicated cache refresh endpoint
                        const response = await fetch('/api/cache/refresh', { method: 'POST' });
                        if (response.ok) {
                            const result = await response.json();
                            // Now reload products
                            await this.refreshProducts(false); // Cache already refreshed
                            console.log(`‚úÖ ${result.message}`);
                        } else {
                            throw new Error('Cache refresh failed');
                        }
                    } catch (error) {
                        console.error('Error refreshing cache:', error);
                        window.toast.error('Refresh Failed', 'Failed to refresh cache');
                    }
                    this.loading = false;
                },

                // Filter products
                filterProducts() {
                    let results = [...this.allProducts];
                    
                    // Apply search filter
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        results = results.filter(p => {
                            return (
                                p.productName?.toLowerCase().includes(query) ||
                                p.description?.toLowerCase().includes(query) ||
                                p.sku?.toLowerCase().includes(query) ||
                                p.tags?.some(tag => tag.toLowerCase().includes(query)) ||
                                p.category?.toLowerCase().includes(query)
                            );
                        });
                    }
                    
                    // Apply range filter
                    if (this.filterRange) {
                        results = results.filter(p => p.range === this.filterRange);
                    }
                    
                    // Apply category filter
                    if (this.filterCategory) {
                        results = results.filter(p => p.category === this.filterCategory);
                    }
                    
                    this.filteredProducts = results;
                    
                    // Reset to page 1 when filters change
                    this.currentPage = 1;
                    
                    // Apply sorting if active
                    if (this.sortColumn) {
                        this.applySort();
                    }
                },

                clearFilters() {
                    this.searchQuery = '';
                    this.filterRange = '';
                    this.filterCategory = '';
                    this.filterProducts();
                },

                // Sorting
                sortBy(column) {
                    if (this.sortColumn === column) {
                        // Toggle direction if same column
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        // New column, default to ascending
                        this.sortColumn = column;
                        this.sortDirection = 'asc';
                    }
                    this.applySort();
                },

                applySort() {
                    if (!this.sortColumn) return;
                    
                    this.filteredProducts.sort((a, b) => {
                        let aVal = a[this.sortColumn] || '';
                        let bVal = b[this.sortColumn] || '';
                        
                        // Handle case-insensitive string comparison
                        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                        
                        if (this.sortDirection === 'asc') {
                            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                        } else {
                            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                        }
                    });
                },

                // Pagination
                get paginatedProducts() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.filteredProducts.slice(start, end);
                },

                get totalPages() {
                    return Math.ceil(this.filteredProducts.length / this.itemsPerPage);
                },

                get pageNumbers() {
                    const total = this.totalPages;
                    const current = this.currentPage;
                    const delta = 2; // Show 2 pages on each side of current
                    const pages = [];
                    
                    for (let i = 1; i <= total; i++) {
                        if (i === 1 || i === total || (i >= current - delta && i <= current + delta)) {
                            pages.push(i);
                        } else if (pages[pages.length - 1] !== '...') {
                            pages.push('...');
                        }
                    }
                    
                    return pages;
                },

                goToPage(page) {
                    if (typeof page === 'number' && page >= 1 && page <= this.totalPages) {
                        this.currentPage = page;
                    }
                },

                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                    }
                },

                prevPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                    }
                },

                firstPage() {
                    this.currentPage = 1;
                },

                lastPage() {
                    this.currentPage = this.totalPages;
                },

                changeItemsPerPage(newSize) {
                    this.itemsPerPage = parseInt(newSize);
                    this.currentPage = 1; // Reset to first page
                },

                // Bulk selection
                get selectedCount() {
                    return this.selectedProducts.size;
                },

                get allPageSelected() {
                    if (this.paginatedProducts.length === 0) return false;
                    return this.paginatedProducts.every(p => this.selectedProducts.has(p.productName));
                },

                toggleProductSelection(productName) {
                    if (this.selectedProducts.has(productName)) {
                        this.selectedProducts.delete(productName);
                    } else {
                        this.selectedProducts.add(productName);
                    }
                    // Force reactivity
                    this.selectedProducts = new Set(this.selectedProducts);
                },

                toggleSelectAll() {
                    if (this.allPageSelected) {
                        // Deselect all on current page
                        this.paginatedProducts.forEach(p => {
                            this.selectedProducts.delete(p.productName);
                        });
                    } else {
                        // Select all on current page
                        this.paginatedProducts.forEach(p => {
                            this.selectedProducts.add(p.productName);
                        });
                    }
                    // Force reactivity
                    this.selectedProducts = new Set(this.selectedProducts);
                },

                deselectAll() {
                    this.selectedProducts.clear();
                    this.selectedProducts = new Set();
                },

                async bulkAutoPopulate() {
                    if (this.selectedCount === 0) return;
                    
                    const selectedArray = Array.from(this.selectedProducts);
                    this.bulkProcessing = true;
                    
                    let successCount = 0;
                    let failCount = 0;
                    
                    window.toast.info('Bulk Processing', `Auto-populating ${selectedArray.length} products...`);
                    
                    for (const productName of selectedArray) {
                        try {
                            await this.autoPopulate(productName);
                            successCount++;
                        } catch (error) {
                            failCount++;
                            console.error(`Failed to auto-populate ${productName}:`, error);
                        }
                    }
                    
                    this.bulkProcessing = false;
                    this.deselectAll();
                    await this.refreshProducts();
                    
                    if (failCount === 0) {
                        window.toast.success('Bulk Complete', `Successfully auto-populated ${successCount} products`);
                    } else {
                        window.toast.warning('Bulk Partial', `Completed: ${successCount} success, ${failCount} failed`);
                    }
                },

                async bulkExtractPreviews() {
                    if (this.selectedCount === 0) return;
                    
                    const selectedArray = Array.from(this.selectedProducts);
                    this.bulkProcessing = true;
                    
                    window.toast.info('Bulk Processing', `Extracting previews for ${selectedArray.length} products...`);
                    
                    try {
                        const response = await fetch('/api/extract-previews', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ productNames: selectedArray })
                        });
                        
                        const result = await response.json();
                        this.bulkProcessing = false;
                        this.deselectAll();
                        
                        if (response.ok) {
                            window.toast.success('Extraction Complete', `Successfully extracted ${result.success || 0} previews`);
                        } else {
                            window.toast.error('Extraction Failed', result.detail || 'Unknown error');
                        }
                    } catch (error) {
                        this.bulkProcessing = false;
                        window.toast.error('Extraction Failed', error.message);
                    }
                },

                // Column visibility
                toggleColumn(columnKey) {
                    this.visibleColumns[columnKey] = !this.visibleColumns[columnKey];
                },

                get visibleColumnCount() {
                    return Object.values(this.visibleColumns).filter(v => v).length;
                },

                async scanDatabase() {
                    this.scanning = true;
                    try {
                        const response = await fetch('/api/scan');
                        await this.refreshProducts();
                        window.toast.success('Scan Complete', 'Database scan finished successfully!');
                    } catch (error) {
                        console.error('Error scanning:', error);
                        window.toast.error('Scan Failed', 'Database scan failed');
                    }
                    this.scanning = false;
                },

                async extractPreviews() {
                    this.extracting = true;
                    try {
                        const response = await fetch('/api/extract-previews', {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            window.toast.success('Extraction Complete', `Extracted ${data.extracted} preview images from 3D files!`);
                            // Refresh to show new previews
                            await this.refreshProducts();
                        } else {
                            const error = await response.json();
                            window.toast.error('Extraction Failed', error.detail);
                        }
                    } catch (error) {
                        console.error('Error extracting previews:', error);
                        window.toast.error('Extraction Failed', 'Failed to extract previews. Check console for details.');
                    }
                    this.extracting = false;
                },

                // Table view helpers
                getFirstHolder(product) {
                    return product.holders && product.holders.length > 0 ? product.holders[0] : null;
                },

                getFirstHolderCode(product) {
                    return product.holders && product.holders.length > 0 
                        ? product.holders[0].codArticol 
                        : '';
                },

                getHolderVariants(product) {
                    if (!product.holders || product.holders.length === 0) return '';
                    return [...new Set(product.holders.map(h => h.variant))].join(', ');
                },

                getHolderColors(product) {
                    if (!product.holders || product.holders.length === 0) return '';
                    return [...new Set(product.holders.map(h => h.color))].join(', ');
                },

                hasHolderPreview(product) {
                    return product.holders && product.holders.some(h => h.preview);
                },

                // Get unique values for dropdown
                getUniqueValues(product, field) {
                    if (!product || !product.holders || product.holders.length === 0) return [];
                    return [...new Set(product.holders.map(h => h[field]))].filter(v => v);
                },

                // Get holder by variant and color selection
                getHolderBySelection(product, variant, color) {
                    if (!product || !product.holders || !variant || !color) return null;
                    return product.holders.find(h => h.variant === variant && h.color === color);
                },

                showPreview(product) {
                    const previewUrl = this.getPreviewUrl(product, 'meshPreview');
                    if (previewUrl) {
                        this.showImagePreview(previewUrl);
                    } else {
                        window.toast.info('No Preview', 'No preview available for ' + product.productName);
                    }
                },

                showHolderPreview(product) {
                    if (product.holders && product.holders.length > 0) {
                        const holder = product.holders.find(h => h.preview);
                        if (holder && holder.preview) {
                            this.showImagePreview(holder.preview);
                        }
                    }
                },

                // Edit modal
                editProduct(product) {
                    // Deep copy to avoid mutating original
                    this.editingProduct = JSON.parse(JSON.stringify(product));
                    this.originalProduct = JSON.parse(JSON.stringify(product));  // Save original for dirty tracking
                    this.isDirty = false;
                    
                    // Ensure tags is an array
                    if (!this.editingProduct.tags) {
                        this.editingProduct.tags = [];
                    }
                    
                    // Ensure holders is an array
                    if (!this.editingProduct.holders) {
                        this.editingProduct.holders = [];
                    }
                    
                    // Ensure packaging is an object
                    if (!this.editingProduct.packaging) {
                        this.editingProduct.packaging = {};
                    }
                    
                    // Set default holder selection to first holder
                    if (this.editingProduct.holders.length > 0) {
                        this.selectedVariant = this.editingProduct.holders[0].variant;
                        this.selectedColor = this.editingProduct.holders[0].color;
                        this.updateHolderSelection();
                    }
                },

                closeEditModal() {
                    // Check for unsaved changes
                    if (this.isDirty) {
                        if (!confirm('You have unsaved changes. Are you sure you want to close?')) {
                            return;
                        }
                    }
                    
                    this.editingProduct = null;
                    this.originalProduct = null;
                    this.isDirty = false;
                    this.selectedVariant = '';
                    this.selectedColor = '';
                    this.selectedHolder = null;
                    this.newTag = '';
                },
                
                // Check if product has been modified
                checkDirty() {
                    if (!this.editingProduct || !this.originalProduct) return;
                    this.isDirty = JSON.stringify(this.editingProduct) !== JSON.stringify(this.originalProduct);
                },
                
                // Revert changes to original
                revertChanges() {
                    if (confirm('Discard all changes and revert to original?')) {
                        this.editingProduct = JSON.parse(JSON.stringify(this.originalProduct));
                        this.isDirty = false;
                    }
                },
                
                // Add new blank holder
                addNewHolder() {
                    if (!this.editingProduct.holders) {
                        this.editingProduct.holders = [];
                    }
                    this.editingProduct.holders.push({
                        variant: '',
                        color: '',
                        codArticol: '',
                        fileName: '',
                        fullPath: '',
                        preview: ''
                    });
                    this.checkDirty();
                },
                
                // Remove holder by index
                removeHolder(index) {
                    if (confirm(`Remove holder #${index + 1}?`)) {
                        this.editingProduct.holders.splice(index, 1);
                        this.checkDirty();
                    }
                },
                
                // Update holder field
                updateHolderField(index, field, value) {
                    if (!this.editingProduct.holders[index]) return;
                    this.editingProduct.holders[index][field] = value;
                    
                    // Update fileName if variant, color, or cod changed
                    const holder = this.editingProduct.holders[index];
                    if (field === 'variant' || field === 'color' || field === 'codArticol') {
                        if (holder.variant && holder.color && holder.codArticol) {
                            holder.fileName = `${holder.variant}_${holder.color}_${holder.codArticol}.3dm`;
                        }
                    }
                    
                    this.checkDirty();
                },
                
                // Save product
                async saveProduct() {
                    try {
                        // Check for file renames needed
                        const renames = this.detectHolderRenames();
                        
                        if (renames.length > 0) {
                            const confirmed = this.confirmRenames(renames);
                            if (!confirmed) return;
                            
                            // Perform renames
                            for (const rename of renames) {
                                const success = await this.renameHolderFile(rename);
                                if (!success) return; // Abort if any rename fails
                            }
                        }
                        
                        // Continue with normal save
                        const response = await fetch(`/api/products/${this.editingProduct.productName}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.editingProduct)
                        });
                        
                        if (response.ok) {
                            await this.refreshProducts();
                            this.isDirty = false;
                            this.originalProduct = JSON.parse(JSON.stringify(this.editingProduct));
                            if (renames.length > 0) {
                                window.toast.success('Product Saved', `Successfully saved! Renamed ${renames.length} file(s).`);
                            } else {
                                window.toast.success('Product Saved', 'All changes saved successfully!');
                            }
                        } else {
                            window.toast.error('Save Failed', 'Failed to save product');
                        }
                    } catch (error) {
                        console.error('Error saving:', error);
                        window.toast.error('Save Failed', 'Failed to save product');
                    }
                },
                
                // Detect holder renames needed
                detectHolderRenames() {
                    const renames = [];
                    if (!this.originalProduct?.holders) return renames;
                    
                    this.editingProduct.holders.forEach((holder, index) => {
                        const original = this.originalProduct.holders[index];
                        if (original && holder.fullPath) {
                            const oldName = this.getHolderFileName(original);
                            const newName = this.getHolderFileName(holder);
                            
                            if (oldName && newName && oldName !== newName) {
                                renames.push({
                                    holderIndex: index,
                                    oldPath: holder.fullPath,
                                    newPath: holder.fullPath.replace(oldName, newName),
                                    oldName: oldName,
                                    newName: newName
                                });
                            }
                        }
                    });
                    
                    return renames;
                },
                
                // Get holder filename from params
                getHolderFileName(holder) {
                    const { variant, color, codArticol } = holder;
                    if (!variant || !color || !codArticol) return '';
                    return `${variant}_${color}_${codArticol}.3dm`;
                },
                
                // Confirm renames with user
                confirmRenames(renames) {
                    const msg = `This will rename ${renames.length} file(s) on the network:\n\n` +
                                renames.map(r => `  ${r.oldName}\n  ‚Üí ${r.newName}`).join('\n\n') +
                                '\n\nContinue?';
                    return confirm(msg);
                },
                
                // Rename a holder file
                async renameHolderFile(rename) {
                    try {
                        const response = await fetch('/api/rename-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                oldPath: rename.oldPath,
                                newPath: rename.newPath,
                                productName: this.editingProduct.productName,
                                holderIndex: rename.holderIndex
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            // Update paths in product
                            this.editingProduct.holders[rename.holderIndex].fullPath = rename.newPath;
                            this.editingProduct.holders[rename.holderIndex].fileName = rename.newName;
                            console.log(`‚úÖ Renamed: ${rename.oldName} ‚Üí ${rename.newName}`);
                            if (result.previewRenamed) {
                                console.log('‚úÖ Preview also renamed');
                            }
                            return true;
                        } else {
                            const error = await response.json();
                            window.toast.error('Rename Failed', `Failed to rename ${rename.oldName}: ${error.detail}`);
                            return false;
                        }
                    } catch (error) {
                        window.toast.error('Rename Failed', `Error renaming file: ${error.message}`);
                        return false;
                    }
                },

                // Holder dropdown functionality
                getUniqueHolderValues(field) {
                    if (!this.editingProduct || !this.editingProduct.holders) return [];
                    return [...new Set(this.editingProduct.holders.map(h => h[field]))].filter(v => v);
                },

                updateHolderSelection() {
                    if (!this.editingProduct || !this.editingProduct.holders) return;
                    
                    // Find holder matching both variant and color
                    this.selectedHolder = this.editingProduct.holders.find(h => 
                        h.variant === this.selectedVariant && h.color === this.selectedColor
                    );
                },

                // Tag management
                addTag() {
                    if (this.newTag && this.newTag.trim()) {
                        if (!this.editingProduct.tags) {
                            this.editingProduct.tags = [];
                        }
                        this.editingProduct.tags.push(this.newTag.trim());
                        this.newTag = '';
                    }
                },

                // Preview helpers
                getPreviewPath(product, previewType) {
                    if (!product) return null;
                    
                    // Handle packaging preview separately
                    if (previewType === 'packagingPreview') {
                        if (product.packaging && product.packaging.preview) {
                            const preview = product.packaging.preview;
                            if (typeof preview === 'string') {
                                if (preview.includes('\\\\') || preview.includes(':')) {
                                    return preview;
                                }
                                return product._folder + '\\\\' + preview;
                            }
                        }
                        return null;
                    }
                    
                    // Handle regular previews
                    if (!product.previews) return null;
                    const preview = product.previews[previewType];
                    if (!preview) return null;
                    
                    // If it's an object with fullPath
                    if (typeof preview === 'object' && preview.fullPath) {
                        return preview.fullPath;
                    }
                    
                    // If it's a string (filename)
                    if (typeof preview === 'string') {
                        // If it's already a full path
                        if (preview.includes('\\\\') || preview.includes(':')) {
                            return preview;
                        }
                        // Otherwise construct from folder
                        return product._folder + '\\\\' + preview;
                    }
                    
                    return null;
                },

                getPreviewUrl(product, previewType) {
                    const path = this.getPreviewPath(product, previewType);
                    if (!path) return '';
                    
                    // Convert to API endpoint
                    // Extract range, category, productName from path
                    const parts = path.split('\\');
                    const productName = product.productName;
                    const fileName = path.substring(path.lastIndexOf('\\') + 1);
                    
                    // Use API endpoint for serving images
                    return `/api/preview/${product.range}/${product.category}/${productName}/${fileName}`;
                },

                getHolderPreviewUrl(previewPath) {
                    if (!previewPath) return '';
                    
                    // If it's already a URL, return it
                    if (previewPath.startsWith('/api')) {
                        return previewPath;
                    }
                    
                    // Extract filename from full path (handle both \ and /)
                    const fileName = previewPath.split(/[\\\/]/).pop();
                    
                    // Use API endpoint
                    return `/api/holder-preview/${fileName}`;
                },

                showImagePreview(imagePath) {
                    if (!imagePath) return;
                    // If it's already a URL (starts with /api), use it directly
                    if (imagePath.startsWith('/api')) {
                        this.imagePreview = imagePath;
                    } else {
                        // Convert path to API endpoint
                        const fileName = imagePath.substring(imagePath.lastIndexOf('\\') + 1);
                        // Check if it's a holder preview or product preview
                        if (imagePath.includes('Holders')) {
                            this.imagePreview = `/api/holder-preview/${fileName}`;
                        } else {
                            this.imagePreview = 'file:///' + imagePath.replace(/\\/g, '/');
                        }
                    }
                },

                closeImagePreview() {
                    this.imagePreview = null;
                },

                async openFilePicker(type) {
                    console.log('üîµ openFilePicker called with type:', type);
                    
                    // Open file picker dialog via API to browse for image
                    if (!this.editingProduct) {
                        console.error('‚ùå No editingProduct');
                        return;
                    }
                    
                    console.log('üìÇ Product folder:', this.editingProduct._folder);
                    
                    try {
                        const response = await fetch('/api/browse-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                folder: this.editingProduct._folder,
                                fileTypes: ['.jpg', '.jpeg', '.png', '.JPG', '.JPEG', '.PNG']
                            })
                        });
                        
                        console.log('üì° API Response status:', response.status);
                        const data = await response.json();
                        console.log('üì¶ API Response data:', data);
                        
                        if (data.selected && data.filePath) {
                            console.log('‚úÖ User selected file:', data.filePath);
                            
                            // Update the product with the selected file
                            if (type === 'mesh') {
                                if (!this.editingProduct.previews) {
                                    this.editingProduct.previews = {};
                                }
                                this.editingProduct.previews.meshPreview = {
                                    fileName: data.fileName,
                                    fullPath: data.filePath
                                };
                            } else if (type === 'grafica') {
                                if (!this.editingProduct.previews) {
                                    this.editingProduct.previews = {};
                                }
                                this.editingProduct.previews.graficaPreview = {
                                    fileName: data.fileName,
                                    fullPath: data.filePath
                                };
                            } else if (type === 'packaging') {
                                if (!this.editingProduct.packaging) {
                                    this.editingProduct.packaging = {};
                                }
                                this.editingProduct.packaging.preview = data.fileName;
                                this.editingProduct.packaging.previewPath = data.filePath;
                            }
                            
                            // Mark as dirty
                            this.isDirty = true;
                            
                            // Force UI update with deep clone to preserve all nested data
                            this.editingProduct = JSON.parse(JSON.stringify(this.editingProduct));
                            
                            window.toast.success('Preview Set', `Preview image updated: ${data.fileName}`);
                        } else {
                            console.log('‚ÑπÔ∏è User cancelled file selection');
                        }
                    } catch (error) {
                        console.error('‚ùå Error opening file picker:', error);
                        window.toast.error('File Picker Failed', `Failed to open file picker: ${error.message}`);
                    }
                },

                async browseHolderPreview() {
                    console.log('üîµ browseHolderPreview called');
                    
                    if (!this.editingProduct || !this.selectedHolder) {
                        console.error('‚ùå No editingProduct or selectedHolder');
                        window.toast.warning('No Holder', 'Please select a holder first');
                        return;
                    }
                    
                    // Construct correct Holders path
                    // Product is in: M:\...\Tools and Holders\PRO\Garden\Product
                    // Holders are in: M:\...\Tools and Holders\Holders\Garden\Previews
                    
                    const productFolder = this.editingProduct._folder;
                    const category = this.editingProduct.category;
                    
                    // Extract base path by removing the last 3 parts (range/category/product)
                    const parts = productFolder.split('\\');
                    const basePath = parts.slice(0, -3).join('\\'); // Gets: M:\...\Tools and Holders
                    const holdersPath = `${basePath}\\Holders\\${category}\\Previews`;
                    
                    console.log('üìÇ Product folder:', productFolder);
                    console.log('üìÅ Category:', category);
                    console.log('üéØ Browsing from Holders path:', holdersPath);
                    
                    try {
                        const response = await fetch('/api/browse-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                folder: holdersPath,
                                fileTypes: ['.jpg', '.jpeg', '.png', '.JPG', '.JPEG', '.PNG']
                            })
                        });
                        
                        const data = await response.json();
                        console.log('üì¶ API Response:', data);
                        
                        if (data.selected && data.filePath) {
                            console.log('‚úÖ User selected holder preview:', data.filePath);
                            
                            // Update the selected holder's preview
                            this.selectedHolder.preview = data.filePath;
                            
                            // Mark as dirty
                            this.isDirty = true;
                            
                            // Force UI update
                            this.editingProduct = JSON.parse(JSON.stringify(this.editingProduct));
                            
                            window.toast.success('Holder Preview Set', `Preview updated: ${data.fileName}`);
                        } else {
                            console.log('‚ÑπÔ∏è User cancelled');
                        }
                    } catch (error) {
                        console.error('‚ùå Error browsing holder preview:', error);
                        window.toast.error('Browse Failed', error.message);
                    }
                },

                // Auto-populate
                async autoPopulate(product) {
                    const productName = product.productName || product;
                    
                    try {
                        const response = await fetch(`/api/products/${productName}/auto-populate`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            const updatedProduct = await response.json();
                            
                            // If editing, update the modal
                            if (this.editingProduct && this.editingProduct.productName === productName) {
                                this.editingProduct = JSON.parse(JSON.stringify(updatedProduct));
                                this.editingProduct._folder = updatedProduct._folder;
                                this.editingProduct._jsonPath = updatedProduct._jsonPath;
                            }
                            
                            await this.refreshProducts();
                            window.toast.success('Auto-Populate Complete', 'Successfully populated all product files!');
                        } else {
                            const error = await response.json();
                            window.toast.error('Auto-Populate Failed', error.detail || 'Unknown error');
                        }
                    } catch (error) {
                        console.error('Error auto-populating:', error);
                        window.toast.error('Auto-Populate Failed', error.message);
                    }
                },

                // File/Folder operations
                async openFolder(folderPath) {
                    if (!folderPath) return;
                    
                    try {
                        const response = await fetch('/api/open-folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: folderPath })
                        });
                        
                        if (!response.ok) {
                            console.error('Failed to open folder');
                        }
                    } catch (error) {
                        console.error('Error opening folder:', error);
                    }
                },

                async revealInExplorer(filePath) {
                    if (!filePath) {
                        window.toast.warning('No Path', 'No file path provided');
                        return;
                    }
                    
                    console.log('Revealing file:', filePath);
                    
                    try {
                        const response = await fetch('/api/reveal-file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: filePath })
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            console.error('Failed to reveal file:', error);
                            window.toast.error('Reveal Failed', `Failed to reveal file: ${error.detail || 'Unknown error'}`);
                        }
                    } catch (error) {
                        console.error('Error revealing file:', error);
                        window.toast.error('Reveal Failed', `Error revealing file: ${error.message}`);
                    }
                },

                // Add product modal
                showAddProduct() {
                    this.addingProduct = true;
                    this.newProductPath = '';
                    this.newProductRange = 'PRO';
                    this.newProductCategory = '';
                    this.newProductSubcategory = '';
                    this.newProductDescription = '';
                    this.newProductSKU = '';
                    this.newProductCodArticol = '';
                    this.newProductTags = '';
                    this.newProductNotes = '';
                    this.newProductHolders = '';
                    this.newProductPackaging = {
                        length: null,
                        width: null,
                        height: null,
                        weight: null
                    };
                },

                closeAddModal() {
                    this.addingProduct = false;
                },

                async createProduct() {
                    if (!this.newProductPath) {
                        window.toast.warning('Missing Path', 'Please enter a product folder path');
                        return;
                    }
                    
                    // Parse holders from textarea (one per line)
                    const holders = this.newProductHolders 
                        ? this.newProductHolders.split('\n').map(h => h.trim()).filter(h => h)
                        : [];
                    
                    // Parse tags from comma-separated string
                    const tags = this.newProductTags
                        ? this.newProductTags.split(',').map(t => t.trim()).filter(t => t)
                        : [];
                    
                    try {
                        const response = await fetch('/api/products/new', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                folderPath: this.newProductPath,
                                range: this.newProductRange,
                                category: this.newProductCategory,
                                subcategory: this.newProductSubcategory,
                                description: this.newProductDescription,
                                sku: this.newProductSKU,
                                codArticol: this.newProductCodArticol,
                                tags: tags,
                                notes: this.newProductNotes,
                                holders: holders,
                                packaging: this.newProductPackaging
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.closeAddModal();
                            await this.refreshProducts();
                            
                            // Auto-populate the new product
                            if (result.productName) {
                                await this.autoPopulate(result.productName);
                            }
                            
                            window.toast.success('Product Created', 'Product created and populated successfully!');
                        } else {
                            const error = await response.json();
                            window.toast.error('Creation Failed', error.detail || 'Unknown error');
                        }
                    } catch (error) {
                        console.error('Error creating product:', error);
                        window.toast.error('Creation Failed', error.message);
                    }
                }
            }
        }
    </script>
</body>
</html>
